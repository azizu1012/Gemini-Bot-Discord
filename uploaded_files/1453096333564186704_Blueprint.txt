ƒê√¢y l√† **Blueprint (S∆° ƒë·ªì chi ti·∫øt)** to√†n b·ªô c√°c b∆∞·ªõc ƒë·ªÉ n√¢ng c·∫•p h·ªá th·ªëng c·ªßa bot c·ªßa b·∫°n, bao g·ªìm h·ªá th·ªëng **Premium Tier** m·ªõi v√† c∆° ch·∫ø **Google Drive Sync** b·ªÅn v·ªØng.

B·∫°n c√≥ th·ªÉ sao ch√©p c·∫•u tr√∫c n√†y v√† cung c·∫•p cho coder n·ªôi b·ªô.

## 1\. Google Drive Sync (B·ªÅn v·ªØng D·ªØ li·ªáu) üíæ

M·ª•c ti√™u: ƒê·ªìng b·ªô 3 file quan tr·ªçng: `chat_history.db` (ch·ª©a Notes), `premium_users.json`, `short_term_memory.json`.

-----

### File: `config.py`

| V·ªã tr√≠ | H√†nh ƒë·ªông | Chi ti·∫øt Thay ƒë·ªïi |
| :--- | :--- | :--- |
| TH√äM | **Google Drive C·∫•u h√¨nh** | ` python # --- GOOGLE DRIVE SYNC --- DRIVE_FOLDER_ID = os.getenv('DRIVE_FOLDER_ID', 'YOUR_DRIVE_FOLDER_ID') # C·∫ßn th√™m v√†o .env  ` |

### File: `database.py`

| V·ªã tr√≠ | H√†nh ƒë·ªông | Chi ti·∫øt Thay ƒë·ªïi |
| :--- | :--- | :--- |
| TH√äM | **Import** | `from config import DB_PATH, logger, DRIVE_FOLDER_ID` |
| TH√äM | **Logic Drive API** | Th√™m c√°c h√†m `_gdrive_upload(local_path, drive_name, folder_id)` v√† `_gdrive_download(drive_name, local_path, folder_id)`. **C·∫ßn thay th·∫ø Stub b·∫±ng code Google Drive API (v√≠ d·ª•: `pydrive2`) th·ª±c t·∫ø.** |
| TH√äM | **H√†m Sync ch√≠nh** | Th√™m 2 h√†m `async def sync_data_to_gdrive()` (upload 3 file) v√† `async def sync_data_from_gdrive()` (download 3 file, overwrite local). |

### File: `bot_core.py`

| V·ªã tr√≠ | H√†nh ƒë·ªông | Chi ti·∫øt Thay ƒë·ªïi |
| :--- | :--- | :--- |
| TH√äM | **Import** | `from discord.ext import commands, tasks` <br> `from database import init_db, cleanup_db, sync_data_to_gdrive, sync_data_from_gdrive` |
| TH√äM | **L·ªãch tr√¨nh Sync** | Th√™m `@tasks.loop(hours=1)` **`drive_sync_scheduler()`**.<br> - **3:00 s√°ng (gi·ªù server)**: Ch·∫°y `sync_data_from_gdrive()` v√† `init_json_memory()` (t·∫£i l·∫°i memory sau khi DB ƒë∆∞·ª£c kh√¥i ph·ª•c).<br> - **17:00 chi·ªÅu (gi·ªù server)**: Ch·∫°y `sync_data_to_gdrive()` (sao l∆∞u). |
| S·ª¨A ƒê·ªîI | **`on_ready()`** | Kh·ªüi ƒë·ªông l·ªãch tr√¨nh: `if not drive_sync_scheduler.is_running(): drive_sync_scheduler.start()`. |

-----

## 2\. H·ªá th·ªëng Premium Tier v√† Qu·∫£n l√Ω d·ªØ li·ªáu (Note) üèÜ

### File: `config.py`

| V·ªã tr√≠ | H√†nh ƒë·ªông | Chi ti·∫øt Thay ƒë·ªïi |
| :--- | :--- | :--- |
| S·ª¨A ƒê·ªîI | **Tier ƒê·ªãnh nghƒ©a** | Thay th·∫ø `PREMIUM_RATE_LIMIT` c≈© b·∫±ng dictionary `PREMIUM_TIERS` m·ªõi: <br>` python PREMIUM_TIERS = { "VIP_0": {"RATE_LIMIT": "20/60", "DM_LIMIT": 15, "NAME": "Standard Premium"}, "VIP_1": {"RATE_LIMIT": "40/60", "DM_LIMIT": 30, "NAME": "Gold VIP"}, "VIP_3": {"RATE_LIMIT": "INF/60", "DM_LIMIT": 99999, "NAME": "Diamond VIP", "CAN_DM_OTHER_USER": True} } DEFAULT_TIER = "FREE"  ` |
| TH√äM | **H√†m Getters** | Th√™m c√°c h√†m helper nh∆∞ `get_user_tier_limits(tier)` v√† `can_dm_other_user(tier)`. |

### File: `premium_manager.py`

| V·ªã tr√≠ | H√†nh ƒë·ªông | Chi ti·∫øt Thay ƒë·ªïi |
| :--- | :--- | :--- |
| S·ª¨A ƒê·ªîI | **C·∫•u tr√∫c D·ªØ li·ªáu** | Thay ƒë·ªïi logic load/save ƒë·ªÉ x·ª≠ l√Ω **`Dict[str, str]`** (User ID -\> Tier Name) thay v√¨ `List[str]`. |
| TH√äM | **`get_user_tier(user_id)`** | Tr·∫£ v·ªÅ Tier Name (`VIP_X` ho·∫∑c `FREE`). |
| TH√äM | **`update_user_tier(user_id, tier_name)`** | C·∫≠p nh·∫≠t Tier cho User. |
| S·ª¨A ƒê·ªîI | **`remove_premium_user`** | N·∫øu user b·ªã x√≥a, ph·∫£i ƒë∆∞a Tier v·ªÅ **`DEFAULT_TIER`** (`FREE`) thay v√¨ x√≥a kh·ªèi list. |

### File: `database.py` (B·∫£o v·ªá Notes)

| V·ªã tr√≠ | H√†nh ƒë·ªông | Chi ti·∫øt Thay ƒë·ªïi |
| :--- | :--- | :--- |
| S·ª¨A ƒê·ªîI | **`clear_all_data_db()`** | **X√≥a d√≤ng `c.execute("DELETE FROM user_notes")`**. Ch·ªâ x√≥a `messages` (l·ªãch s·ª≠ chat). |
| S·ª¨A ƒê·ªîI | **`clear_user_data_db(user_id)`** | **X√≥a d√≤ng `c.execute("DELETE FROM user_notes WHERE user_id = ?")`**. Ch·ªâ x√≥a `messages` c·ªßa User ƒë√≥. |

### File: `bot_core.py` (L·ªánh Slash)

| V·ªã tr√≠ | L·ªánh / Bi·∫øn | Chi ti·∫øt Logic |
| :--- | :--- | :--- |
| TH√äM | **Bi·∫øn Global** | `UPGRADE_TOKENS: Dict[str, str] = {} # {token_hash: tier_name}` |
| TH√äM | **L·ªánh Admin** | **`/generate_token_upgrade tier:VIP_X`**: <br> 1. Ki·ªÉm tra Admin ID. <br> 2. T·∫°o `uuid` ng·∫´u nhi√™n. <br> 3. Hash token (`hashlib.sha256`). <br> 4. L∆∞u `hash: tier` v√†o `UPGRADE_TOKENS`. <br> 5. G·ª≠i **token th√¥** cho Admin (ephemeral). |
| TH√äM | **L·ªánh User** | **`/premium action:upgrade token:X`**: <br> 1. Hash token user nh·∫≠p. <br> 2. Ki·ªÉm tra `UPGRADE_TOKENS`. <br> 3. N·∫øu OK, g·ªçi `premium_manager.update_user_tier()`. <br> 4. **X√≥a token kh·ªèi `UPGRADE_TOKENS`**. |
| TH√äM | **L·ªánh User** | **`/premium action:check`**: <br> 1. G·ªçi `premium_manager.get_user_tier()`. <br> 2. Hi·ªÉn th·ªã gi·ªõi h·∫°n t·ª´ `config.PREMIUM_TIERS`. |

### File: `message_handler.py` (DM cho VIP\_3)

| V·ªã tr√≠ | H√†nh ƒë·ªông | Chi ti·∫øt Logic |
| :--- | :--- | :--- |
| TH√äM | **H√†m ki·ªÉm tra** | Th√™m h√†m `is_dm_allowed_tier(user_id)` m·ªõi. <br> Logic: `return user_id == ADMIN_ID or config.can_dm_other_user(premium_manager.get_user_tier(user_id))` |
| S·ª¨A ƒê·ªîI | **X·ª≠ l√Ω DM** | Thay th·∫ø m·ªçi l·ªánh ki·ªÉm tra quy·ªÅn DM User kh√°c (`if premium_manager.is_admin_user(user_id):`) b·∫±ng **`if is_dm_allowed_tier(user_id):`** ƒë·ªÉ √°p d·ª•ng cho VIP\_3. |